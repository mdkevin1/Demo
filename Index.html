<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f9; }
        /* Style for the video feed/scanner area */
        #scanner-container {
            width: 100%;
            max-width: 400px; /* Maximize visibility on mobile, constrain on desktop */
            margin: 0 auto;
            position: relative;
            aspect-ratio: 4 / 3;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        #video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .scan-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: #ef4444; /* Red for emphasis */
            box-shadow: 0 0 10px #ef4444;
            transform: translateY(-50%);
            animation: scan 2s infinite alternate;
        }
        @keyframes scan {
            from { top: 0%; }
            to { top: 100%; }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app-container" class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">üì¶ Inventory Hub (Local)</h1>

        <div id="mode-selector" class="flex flex-wrap gap-3 mb-6">
            <button id="mode-manage" class="mode-button bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition shadow-md active-mode">
                Add / Edit Product
            </button>
            <button id="mode-check" class="mode-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition shadow-md">
                Check Price
            </button>
        </div>

        <div id="main-content">
            <div id="scanner-view" class="mb-8 hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Scan Barcode</h2>
                <div id="scanner-container">
                    <video id="video-feed" class="w-full h-full" autoplay playsinline></video>
                    <div class="scan-line"></div>
                </div>
                <div id="scan-feedback" class="text-center text-sm mt-3 text-gray-500">
                    Point your camera at a barcode.
                </div>
            </div>

            <div id="form-view" class="mb-8 hidden">
                <h2 id="form-title" class="text-xl font-semibold text-gray-700 mb-4">Add New Product</h2>
                <form id="product-form" class="space-y-4">
                    <div>
                        <label for="barcode" class="block text-sm font-medium text-gray-700">Barcode (UPC/EAN)</label>
                        <input type="text" id="barcode" name="barcode" required readonly
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 bg-gray-100 cursor-not-allowed">
                    </div>
                    
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="name" name="name" required
                               class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="e.g., Organic Bananas, 24oz Can of Soda">
                    </div>

                    <div>
                        <label for="size" class="block text-sm font-medium text-gray-700">Size/Unit (e.g., L, 500g, Pair)</label>
                        <input type="text" id="size" name="size" required
                               class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">Price ($)</label>
                        <input type="number" id="price" name="price" required step="0.01" min="0"
                               class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="flex gap-4">
                        <button type="submit" id="save-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition">
                            Save Product
                        </button>
                        <button type="button" id="cancel-button" class="w-1/3 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition">
                            Cancel
                        </button>
                    </div>
                    <input type="hidden" id="docId" name="docId">
                </form>
            </div>

            <div id="price-check-view" class="mb-8 hidden text-center">
                <div class="p-6 bg-yellow-50 rounded-xl shadow-inner">
                    <p class="text-2xl text-gray-600">Scanned Barcode:</p>
                    <p id="check-barcode" class="text-3xl font-mono font-bold text-gray-800 break-all my-3">---</p>
                    <div id="check-result">
                        </div>
                </div>
                <button id="rescan-button" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition">
                    Scan Next Item
                </button>
            </div>

            <div id="list-view" class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Saved Products (<span id="product-count">0</span>)</h2>
                <div id="product-list" class="space-y-3">
                    <p class="text-gray-500 text-center p-4" id="empty-message">No products saved yet. Scan a barcode to add the first one!</p>
                    </div>
                <div class="mt-6 text-center">
                    <button id="start-scan-add" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl transition transform hover:scale-105">
                        <span class="text-lg">‚ûï Start Scan & Add New</span>
                    </button>
                </div>

                <div class="mt-4 flex flex-wrap gap-2 justify-center">
                    <button id="export-data" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition shadow-md">
                        <span class="text-sm">üì• Export Data (JSON)</span>
                    </button>
                    <button id="import-data" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2 px-4 rounded-lg transition shadow-md">
                        <span class="text-sm">‚¨ÜÔ∏è Import Data (JSON)</span>
                    </button>
                    <input type="file" id="import-file-input" accept=".json" class="hidden">
                </div>
                </div>

            <div class="mt-8 p-3 bg-gray-100 rounded-lg text-xs text-gray-600">
                <p><strong>App ID:</strong> <span id="display-app-id">inventory-manager-local</span> (Data is stored locally in your browser.)</p>
            </div>

            <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                    <h3 id="modal-title" class="text-lg font-bold mb-3">Message</h3>
                    <p id="modal-message" class="text-gray-700 mb-4">Content here.</p>
                    <div id="modal-buttons" class="flex gap-2 justify-end mt-4">
                        <button id="modal-cancel" class="hidden bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button id="modal-confirm" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
                        <button id="modal-close" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg w-full">Close</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

    <script>
        // Access global ZXing properties now that the script is loaded
        const BrowserMultiFormatReader = ZXing.BrowserMultiFormatReader;
        const DecodeHintType = ZXing.DecodeHintType;

        // --- GLOBAL STATE & CONFIG ---
        let products = []; // Array to hold all products in memory
        let currentMode = 'manage'; // 'manage' or 'check'
        let currentDocId = null; // For editing existing items
        let codeReader = null;
        let scannedBarcode = null;

        const appId = 'inventory-manager-local'; // Simplified App ID
        const LOCAL_STORAGE_KEY = 'inventoryProducts';

        // --- UTILITY FUNCTIONS ---

        /**
         * Displays a simple message/error modal.
         * @param {string} title - The modal title.
         * @param {string} message - The modal body message.
         * @param {boolean} isError - If true, styles the title/button as an error (red).
         */
        function showModal(title, message, isError = true) {
            const modal = document.getElementById('custom-modal');
            
            // Set content and styling
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-title').className = `text-lg font-bold mb-3 ${isError ? 'text-red-600' : 'text-green-600'}`;
            document.getElementById('modal-message').textContent = message;

            // Show only the 'Close' button and hide others
            document.getElementById('modal-close').classList.remove('hidden');
            document.getElementById('modal-confirm').classList.add('hidden');
            document.getElementById('modal-cancel').classList.add('hidden');
            document.getElementById('modal-close').classList.add('w-full');
            
            // Ensure the close button uses a standard color
            const buttonColor = isError ? 'red' : 'blue';
            document.getElementById('modal-close').className = `bg-${buttonColor}-600 hover:bg-${buttonColor}-700 text-white font-bold py-2 px-4 rounded-lg w-full`;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        /**
         * Displays a confirmation modal with Confirm/Cancel buttons.
         * @param {string} title - The modal title.
         * @param {string} message - The modal body message.
         * @param {function(boolean): void} callback - Function to execute on user response (true for confirm, false for cancel).
         */
        function showConfirm(title, message, callback) {
            const modal = document.getElementById('custom-modal');

            // Set content and styling (as a warning/confirmation)
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-title').className = 'text-lg font-bold mb-3 text-red-600';
            document.getElementById('modal-message').textContent = message;

            // Show Confirm/Cancel buttons and hide Close
            document.getElementById('modal-close').classList.add('hidden');
            document.getElementById('modal-confirm').classList.remove('hidden');
            document.getElementById('modal-cancel').classList.remove('hidden');
            document.getElementById('modal-close').classList.remove('w-full'); // Reset close button width

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Set up temporary listeners for confirmation
            const handleResponse = (isConfirmed) => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                // Remove listeners to prevent memory leaks/double execution
                document.getElementById('modal-confirm').onclick = null;
                document.getElementById('modal-cancel').onclick = null;
                callback(isConfirmed);
            };

            document.getElementById('modal-confirm').onclick = () => handleResponse(true);
            document.getElementById('modal-cancel').onclick = () => handleResponse(false);
        }

        // Setup the standard close handler for the message modal
        document.getElementById('modal-close').onclick = () => {
            document.getElementById('custom-modal').classList.remove('flex');
            document.getElementById('custom-modal').classList.add('hidden');
        };

        // --- LOCAL STORAGE FUNCTIONS ---

        function loadProducts() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                const loadedProducts = data ? JSON.parse(data) : [];
                // Ensure price is treated as a number during loads
                return loadedProducts.map(p => ({
                    ...p,
                    price: parseFloat(p.price) 
                }));
            } catch (e) {
                console.error("Error loading products from localStorage:", e);
                return [];
            }
        }

        function saveProducts(productsArray) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(productsArray));
            } catch (e) {
                console.error("Error saving products to localStorage:", e);
                showModal('Storage Error', 'Could not save data. Local storage might be full.', true);
            }
        }

        // --- DATA FUNCTIONS (LOCALSTORAGE BASED) ---

        async function saveProduct(productData) {
            try {
                let isNew = !productData.docId;
                const priceValue = parseFloat(productData.price);

                if (isNew) {
                    // Add new product with a generated ID and timestamp
                    const newProduct = {
                        id: crypto.randomUUID(), // Generate a unique ID
                        barcode: productData.barcode,
                        name: productData.name, // NEW FIELD
                        size: productData.size,
                        price: priceValue,
                        updatedAt: Date.now()
                    };
                    // Check if barcode already exists for a new product, though the form logic handles this by pre-filling
                    const existing = products.find(p => p.barcode === newProduct.barcode);
                    if (existing) {
                        // Switch to editing the existing product instead of adding a duplicate
                        newProduct.id = existing.id;
                        newProduct.updatedAt = Date.now();
                        const index = products.findIndex(p => p.id === existing.id);
                        products[index] = newProduct;
                        isNew = false;
                    } else {
                        products.push(newProduct);
                    }
                } else {
                    // Update existing product
                    const index = products.findIndex(p => p.id === productData.docId);
                    if (index !== -1) {
                        products[index] = {
                            ...products[index],
                            name: productData.name, // UPDATED FIELD
                            size: productData.size,
                            price: priceValue,
                            updatedAt: Date.now()
                        };
                    }
                }

                // Sort the in-memory array by update time, descending
                products.sort((a, b) => b.updatedAt - a.updatedAt); 

                saveProducts(products); // Save to localStorage
                renderProductList(products); // Update UI
                showModal('Success', `Product ${isNew ? 'added' : 'updated'} successfully!`, false);
                switchToView('list');
            } catch (e) {
                console.error("Error saving product:", e);
                showModal('Save Error', `Could not save product: ${e.message}`, true);
            }
        }

        function deleteProduct(docId) {
             showConfirm(
                'Confirm Deletion',
                'Are you sure you want to permanently delete this product? This action cannot be undone.',
                (confirmed) => {
                    if (confirmed) {
                        try {
                            products = products.filter(p => p.id !== docId);
                            saveProducts(products);
                            renderProductList(products);
                            showModal('Deleted', 'Product deleted successfully.', false);
                        } catch (e) {
                            console.error("Error deleting product: ", e);
                            showModal('Delete Error', `Could not delete product: ${e.message}`, true);
                        }
                    }
                }
             );
        }

        function loadInitialProducts() {
            products = loadProducts();
            renderProductList(products);
        }

        // --- NEW: EXPORT/IMPORT FUNCTIONS ---

        function exportData() {
            if (products.length === 0) {
                showModal('Export Failed', 'There are no products to export.', true);
                return;
            }
            
            try {
                const dataStr = JSON.stringify(products, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = 'inventory_data.json';
                
                // Create a temporary link element to trigger the download
                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click(); // Programmatically click the link to trigger download

                showModal('Export Successful', `Exported ${products.length} products to ${exportFileDefaultName}.`, false);

            } catch (e) {
                console.error("Export Error:", e);
                showModal('Export Error', 'An error occurred during data export.', true);
            }
        }

        function importData() {
            const fileInput = document.getElementById('import-file-input');
            fileInput.click(); // Trigger the file selection dialog
        }

        document.getElementById('import-file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== "application/json") {
                showModal('Import Failed', 'Please select a valid JSON file.', true);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedProducts = JSON.parse(e.target.result);

                    if (!Array.isArray(importedProducts) || importedProducts.some(p => !p.barcode || p.price === undefined)) {
                        showModal('Import Failed', 'The JSON file structure is invalid or missing required fields (barcode, price).', true);
                        return;
                    }
                    
                    showConfirm(
                        'Confirm Import',
                        `Are you sure you want to replace your current ${products.length} products with ${importedProducts.length} items from the imported file? This action is permanent.`,
                        (confirmed) => {
                            if (confirmed) {
                                // Filter and sanitize imported data
                                products = importedProducts.map(p => ({
                                    ...p,
                                    // Ensure proper types and fill missing fields
                                    id: p.id || crypto.randomUUID(), 
                                    name: p.name || 'Untitled Product',
                                    size: p.size || 'N/A',
                                    price: parseFloat(p.price) || 0,
                                    updatedAt: p.updatedAt || Date.now()
                                }));
                                
                                // Re-sort and save
                                products.sort((a, b) => b.updatedAt - a.updatedAt); 
                                saveProducts(products);
                                renderProductList(products);
                                showModal('Import Successful', `${products.length} products imported and saved successfully.`, false);
                            }
                        }
                    );

                } catch (error) {
                    console.error("Import Parsing Error:", error);
                    showModal('Import Error', 'Could not process the JSON file. It might be corrupt or malformed.', true);
                }
            };
            reader.readAsText(file);
            // Clear the file input so the same file can be selected again
            event.target.value = null; 
        });

        // --- END NEW: EXPORT/IMPORT FUNCTIONS ---

        // --- BARCODE SCANNING FUNCTIONS (ZXING) ---

        function getHints() {
            const hints = new Map();
            // Focus on common formats for retail inventory
            hints.set(DecodeHintType.POSSIBLE_FORMATS, [
                ZXing.BarcodeFormat.EAN_13, 
                ZXing.BarcodeFormat.EAN_8, 
                ZXing.BarcodeFormat.UPC_A, 
                ZXing.BarcodeFormat.UPC_E, 
                ZXing.BarcodeFormat.CODE_128, 
                ZXing.BarcodeFormat.CODE_39
            ]);
            return hints;
        }

        function stopScanner() {
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
                console.log("Scanner stopped and reset.");
            }
        }

        async function startScanner() {
            // STOP 1: Stop any previous reader before initializing a new one
            stopScanner(); 

            // A check to see if the library was successfully loaded
            if (typeof BrowserMultiFormatReader === 'undefined') {
                 showModal('Critical Error', 'Barcode scanning library failed to load (ZXing not found). Check internet connection.', true);
                 console.error("BrowserMultiFormatReader is undefined. Global ZXing object missing.");
                 switchToView('list');
                 return;
            }

            // Prepare the reader with hints
            codeReader = new BrowserMultiFormatReader(getHints());

            // Switch to scanner view
            switchToView('scanner'); 

            try {
                const videoElement = document.getElementById('video-feed');
                document.getElementById('scan-feedback').textContent = 'Starting camera...';

                // This call should now succeed as codeReader is guaranteed to be an instance
                await codeReader.decodeFromVideoDevice(null, videoElement, (result, error) => {
                    if (result) {
                        handleScanSuccess(result.text);
                    }
                    if (error && !(error instanceof MediaStreamTrack)) {
                        // Ignore frequent internal ZXing errors
                    }
                });

                document.getElementById('scan-feedback').textContent = 'Scanning in progress...';
            } catch (err) {
                console.error("Camera access failed:", err);
                
                // Enhanced error reporting for the user
                let errorMessage = 'Could not access the camera. Check permissions and ensure no other app is using it.';
                if (err.name === 'NotAllowedError' || err.name === 'SecurityError') {
                    errorMessage = 'Camera access denied or blocked. You must be on a secure connection (HTTPS) and grant permission when prompted.';
                } else if (err.name === 'NotFoundError') {
                     errorMessage = 'No camera device found on this system.';
                } else if (err.message && err.message.includes('permission denied')) {
                     errorMessage = 'Camera permission was explicitly denied by the user or the browser.';
                }
                
                // This modal should now pop up and tell the user exactly what's wrong
                showModal('Camera Error', errorMessage, true);
                switchToView('list');
            }
        }

        function handleScanSuccess(barcode) {
            // Explicitly stop scanner when we have a result
            stopScanner(); 
            scannedBarcode = barcode;
            document.getElementById('scan-feedback').textContent = `Barcode Found: ${barcode}`;

            if (currentMode === 'manage') {
                // Management Mode: Go to form
                loadFormWithBarcode(barcode);
            } else if (currentMode === 'check') {
                // Price Check Mode: Go to display
                displayPriceCheck(barcode);
            }
        }

        // --- UI & VIEW MANAGEMENT ---

        function switchToView(viewName, skipScanButton = false) {
            const views = {
                'scanner': document.getElementById('scanner-view'),
                'form': document.getElementById('form-view'),
                'list': document.getElementById('list-view'),
                'price-check-view': document.getElementById('price-check-view')
            };

            Object.keys(views).forEach(key => {
                if (views[key]) {
                    views[key].classList.add('hidden');
                }
            });

            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }

            // Special handling for management mode buttons
            document.getElementById('start-scan-add').classList.toggle('hidden', viewName !== 'list' || skipScanButton);
        }

        function loadFormWithBarcode(barcode) {
            currentDocId = null;
            document.getElementById('product-form').reset();
            document.getElementById('form-title').textContent = `Add New Product: ${barcode}`;
            document.getElementById('barcode').value = barcode;
            document.getElementById('save-button').textContent = 'Save Product';

            // Check if this barcode already exists in the current list
            const existingProduct = products.find(p => p.barcode === barcode);

            if (existingProduct) {
                // Pre-fill for editing
                currentDocId = existingProduct.id;
                document.getElementById('docId').value = existingProduct.id;
                document.getElementById('form-title').textContent = `Edit Existing Product: ${barcode}`;
                document.getElementById('name').value = existingProduct.name || ''; // LOAD NEW FIELD
                document.getElementById('size').value = existingProduct.size;
                document.getElementById('price').value = existingProduct.price;
                document.getElementById('save-button').textContent = 'Update Product';
            }

            switchToView('form');
        }

        function renderProductList(productsToRender) {
            const list = document.getElementById('product-list');
            const count = document.getElementById('product-count');
            const emptyMsg = document.getElementById('empty-message');

            list.innerHTML = '';
            count.textContent = productsToRender.length;

            if (productsToRender.length === 0) {
                emptyMsg.classList.remove('hidden');
                list.appendChild(emptyMsg);
                return;
            }
            emptyMsg.classList.add('hidden');

            productsToRender.forEach(p => {
                // p.updatedAt is a timestamp (number)
                const date = p.updatedAt ? new Date(p.updatedAt).toLocaleString() : 'N/A';
                const productName = p.name || 'Untitled Product';

                const item = document.createElement('div');
                item.className = 'product-item flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200 transition hover:shadow-md';
                item.dataset.id = p.id;
                item.dataset.barcode = p.barcode;
                // Ensure size and price are strings for dataset attributes
                item.dataset.size = p.size;
                item.dataset.price = p.price.toString();

                item.innerHTML = `
                    <div>
                        <p class="text-lg font-semibold text-gray-800">${productName}</p> <p class="text-sm text-gray-600 break-all">Barcode: ${p.barcode}</p>
                        <p class="text-xs text-gray-500">Size: ${p.size}</p>
                        <p class="text-xs text-gray-500">Last updated: ${date}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-green-600">$${parseFloat(p.price).toFixed(2)}</p>
                        <div class="flex gap-2 mt-1">
                            <button data-id="${p.id}" data-action="edit" class="text-blue-500 hover:text-blue-700 text-sm font-medium">Edit</button>
                            <button data-id="${p.id}" data-action="delete" class="text-red-500 hover:text-red-700 text-sm font-medium">Delete</button>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function displayPriceCheck(barcode) {
             // We are leaving the scanner view, so stop it explicitly
             stopScanner(); 
             switchToView('price-check-view', true);
             document.getElementById('check-barcode').textContent = barcode;
             const resultDisplay = document.getElementById('check-result');
             resultDisplay.innerHTML = `<p class="text-gray-500 text-xl font-medium">Searching products...</p>`;

             // Find product directly from in-memory array
             const product = products.find(p => p.barcode === barcode);

             if (product) {
                 const price = product.price;
                 const size = product.size;
                 const name = product.name || 'Untitled Product';
                 
                 resultDisplay.innerHTML = `
                    <div class="mt-4 p-4 bg-green-100 rounded-lg">
                        <p class="text-xl font-extrabold text-green-800">${name}</p>
                        <p class="text-4xl font-extrabold text-green-700">$${parseFloat(price).toFixed(2)}</p>
                        <p class="text-lg text-gray-700 mt-1">Size/Unit: ${size}</p>
                    </div>
                 `;
             } else {
                 resultDisplay.innerHTML = `
                    <div class="mt-4 p-4 bg-red-100 rounded-lg">
                        <p class="text-xl font-extrabold text-red-700">Product Not Found</p>
                        <p class="text-md text-gray-700 mt-1">Barcode <strong>${barcode}</strong> has no saved price.</p>
                    </div>
                 `;
             }
        }


        // --- EVENT HANDLERS ---

        document.getElementById('product-form').addEventListener('submit', (e) => {
            e.preventDefault();
            // We are leaving the scanner view, so stop it explicitly
            stopScanner();
            
            const form = e.target;
            const productData = {
                docId: form.docId.value || null,
                barcode: form.barcode.value.trim(),
                name: form.name.value.trim(), // CAPTURE NEW FIELD
                size: form.size.value.trim(),
                price: parseFloat(form.price.value)
            };

            // VALIDATION
            if (!productData.name) {
                 showModal('Input Error', 'Please enter a product name.', true);
                 return;
            }
            if (isNaN(productData.price) || productData.price < 0) {
                showModal('Input Error', 'Please enter a valid price.', true);
                return;
            }
            if (!productData.size) {
                 showModal('Input Error', 'Please enter a size/unit.', true);
                 return;
            }

            saveProduct(productData);
        });

        document.getElementById('cancel-button').addEventListener('click', () => {
            // We are leaving the form/scanner view, so stop it explicitly
            stopScanner();
            switchToView('list');
        });

        document.getElementById('product-list').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const action = button.dataset.action;
            const id = button.dataset.id;

            if (action === 'edit') {
                const itemElement = button.closest('.product-item');
                const barcode = itemElement.dataset.barcode;
                loadFormWithBarcode(barcode); // Reloads the form pre-filled for editing
            } else if (action === 'delete') {
                deleteProduct(id);
            }
        });

        document.getElementById('start-scan-add').addEventListener('click', () => {
            startScanner();
        });

        document.getElementById('rescan-button').addEventListener('click', () => {
            startScanner();
        });

        // NEW: Event listeners for Export/Import
        document.getElementById('export-data').addEventListener('click', exportData);
        document.getElementById('import-data').addEventListener('click', importData);

        // Mode switching logic (still uses localStorage)
        function setMode(mode) {
            currentMode = mode;
            // Save the user's preferred mode to localStorage
            localStorage.setItem('inventoryMode', mode);

            const manageBtn = document.getElementById('mode-manage');
            const checkBtn = document.getElementById('mode-check');

            // Update button styles
            manageBtn.classList.remove('active-mode', 'bg-blue-600', 'bg-gray-500');
            checkBtn.classList.remove('active-mode', 'bg-blue-600', 'bg-gray-500');

            if (mode === 'manage') {
                manageBtn.classList.add('bg-blue-600', 'active-mode');
                checkBtn.classList.add('bg-gray-500');
                // We are leaving the check/scanner view, so stop it explicitly
                stopScanner(); 
                switchToView('list');
            } else { // 'check' mode
                checkBtn.classList.add('bg-blue-600', 'active-mode');
                manageBtn.classList.add('bg-gray-500');
                // Start scanning immediately in price check mode
                startScanner();
            }
        }

        document.getElementById('mode-manage').addEventListener('click', () => setMode('manage'));
        document.getElementById('mode-check').addEventListener('click', () => setMode('check'));

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
             // 1. Load mode from localStorage if available
             const savedMode = localStorage.getItem('inventoryMode');
             if (savedMode) {
                 currentMode = savedMode;
             }

             // 2. Set initial button styles based on the determined currentMode
             const manageBtn = document.getElementById('mode-manage');
             const checkBtn = document.getElementById('mode-check');

             if (currentMode === 'manage') {
                 manageBtn.classList.remove('bg-gray-500');
                 manageBtn.classList.add('bg-blue-600');
                 checkBtn.classList.remove('bg-blue-600');
                 checkBtn.classList.add('bg-gray-500');
             } else {
                 manageBtn.classList.remove('bg-blue-600');
                 manageBtn.classList.add('bg-gray-500');
                 checkBtn.classList.remove('bg-gray-500');
                 checkBtn.classList.add('bg-blue-600');
             }

             // 3. Load products and set initial view
             loadInitialProducts();

             if (currentMode === 'check') {
                 startScanner();
             } else {
                 switchToView('list');
             }
        });
    </script>
</body>
</html>
