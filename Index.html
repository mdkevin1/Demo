<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f9; }
        /* Style for the video feed/scanner area */
        #scanner-container {
            width: 100%;
            max-width: 400px; /* Maximize visibility on mobile, constrain on desktop */
            margin: 0 auto;
            position: relative;
            aspect-ratio: 4 / 3;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        #video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .scan-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: #ef4444; /* Red for emphasis */
            box-shadow: 0 0 10px #ef4444;
            transform: translateY(-50%);
            animation: scan 2s infinite alternate;
        }
        @keyframes scan {
            from { top: 0%; }
            to { top: 100%; }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app-container" class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">ðŸ“¦ Inventory Hub (Local)</h1>

        <!-- Mode Selection -->
        <div id="mode-selector" class="flex flex-wrap gap-3 mb-6">
            <button id="mode-manage" class="mode-button bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition shadow-md active-mode">
                Add / Edit Product
            </button>
            <button id="mode-check" class="mode-button bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition shadow-md">
                Check Price
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="main-content">
            <!-- 1. Scanner View -->
            <div id="scanner-view" class="mb-8 hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Scan Barcode</h2>
                <div id="scanner-container">
                    <video id="video-feed" class="w-full h-full" autoplay playsinline></video>
                    <div class="scan-line"></div>
                </div>
                <div id="scan-feedback" class="text-center text-sm mt-3 text-gray-500">
                    Point your camera at a barcode.
                </div>
            </div>

            <!-- 2. Product Form View (Add/Edit) -->
            <div id="form-view" class="mb-8 hidden">
                <h2 id="form-title" class="text-xl font-semibold text-gray-700 mb-4">Add New Product</h2>
                <form id="product-form" class="space-y-4">
                    <div>
                        <label for="barcode" class="block text-sm font-medium text-gray-700">Barcode (UPC/EAN)</label>
                        <input type="text" id="barcode" name="barcode" required readonly
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 bg-gray-100 cursor-not-allowed">
                    </div>
                    <div>
                        <label for="size" class="block text-sm font-medium text-gray-700">Size/Unit (e.g., L, 500g, Pair)</label>
                        <input type="text" id="size" name="size" required
                               class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700">Price ($)</label>
                        <input type="number" id="price" name="price" required step="0.01" min="0"
                               class="mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="flex gap-4">
                        <button type="submit" id="save-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition">
                            Save Product
                        </button>
                        <button type="button" id="cancel-button" class="w-1/3 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition">
                            Cancel
                        </button>
                    </div>
                    <input type="hidden" id="docId" name="docId">
                </form>
            </div>

            <!-- 3. Price Check Display -->
            <div id="price-check-view" class="mb-8 hidden text-center">
                <div class="p-6 bg-yellow-50 rounded-xl shadow-inner">
                    <p class="text-2xl text-gray-600">Scanned Barcode:</p>
                    <p id="check-barcode" class="text-3xl font-mono font-bold text-gray-800 break-all my-3">---</p>
                    <div id="check-result">
                        <!-- Content inserted here -->
                    </div>
                </div>
                <button id="rescan-button" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg shadow-lg transition">
                    Scan Next Item
                </button>
            </div>

            <!-- 4. Product List View (Management Mode Default) -->
            <div id="list-view" class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Saved Products (<span id="product-count">0</span>)</h2>
                <div id="product-list" class="space-y-3">
                    <p class="text-gray-500 text-center p-4" id="empty-message">No products saved yet. Scan a barcode to add the first one!</p>
                    <!-- Products will be injected here -->
                </div>
                <div class="mt-6 text-center">
                    <button id="start-scan-add" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl transition transform hover:scale-105">
                        <span class="text-lg">âž• Start Scan & Add New</span>
                    </button>
                </div>
            </div>

            <!-- App ID Display -->
            <div class="mt-8 p-3 bg-gray-100 rounded-lg text-xs text-gray-600">
                <p><strong>App ID:</strong> <span id="display-app-id">inventory-manager-local</span> (Data is stored locally in your browser.)</p>
            </div>

            <!-- Custom Modal for Messages/Errors -->
            <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                    <h3 id="modal-title" class="text-lg font-bold mb-3 text-red-600">Error</h3>
                    <p id="modal-message" class="text-gray-700 mb-4">An unknown error occurred.</p>
                    <button id="modal-close" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg">Close</button>
                </div>
            </div>

        </div>
    </div>

    <!-- ZXing Scripts -->
    <script type="module">
        import { BrowserMultiFormatReader, DecodeHintType } from 'https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/esm/index.js';

        // --- GLOBAL STATE & CONFIG ---
        let products = []; // Array to hold all products in memory
        let currentMode = 'manage'; // 'manage' or 'check'
        let currentDocId = null; // For editing existing items
        let codeReader = null;
        let scannedBarcode = null;

        const appId = 'inventory-manager-local'; // Simplified App ID
        const LOCAL_STORAGE_KEY = 'inventoryProducts';

        // --- UTILITY FUNCTIONS ---

        function showModal(title, message, isError = true) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-title').className = `text-lg font-bold mb-3 ${isError ? 'text-red-600' : 'text-green-600'}`;
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('modal-close').onclick = () => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            };
        }

        // --- LOCAL STORAGE FUNCTIONS ---

        function loadProducts() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                const loadedProducts = data ? JSON.parse(data) : [];
                // Ensure price is treated as a number during loads
                return loadedProducts.map(p => ({
                    ...p,
                    price: parseFloat(p.price) 
                }));
            } catch (e) {
                console.error("Error loading products from localStorage:", e);
                return [];
            }
        }

        function saveProducts(productsArray) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(productsArray));
            } catch (e) {
                console.error("Error saving products to localStorage:", e);
                showModal('Storage Error', 'Could not save data. Local storage might be full.', true);
            }
        }

        // --- DATA FUNCTIONS (LOCALSTORAGE BASED) ---

        async function saveProduct(productData) {
            try {
                let isNew = !productData.docId;
                const priceValue = parseFloat(productData.price);

                if (isNew) {
                    // Add new product with a generated ID and timestamp
                    const newProduct = {
                        id: crypto.randomUUID(), // Generate a unique ID
                        barcode: productData.barcode,
                        size: productData.size,
                        price: priceValue,
                        updatedAt: Date.now()
                    };
                    products.push(newProduct);
                } else {
                    // Update existing product
                    const index = products.findIndex(p => p.id === productData.docId);
                    if (index !== -1) {
                        products[index] = {
                            ...products[index],
                            size: productData.size,
                            price: priceValue,
                            updatedAt: Date.now()
                        };
                    }
                }

                // Sort the in-memory array by update time, descending
                products.sort((a, b) => b.updatedAt - a.updatedAt); 

                saveProducts(products); // Save to localStorage
                renderProductList(products); // Update UI
                showModal('Success', `Product ${isNew ? 'added' : 'updated'} successfully!`, false);
                switchToView('list');
            } catch (e) {
                console.error("Error saving product:", e);
                showModal('Save Error', `Could not save product: ${e.message}`, true);
            }
        }

        function deleteProduct(docId) {
             // Replacing confirm() with showModal for error handling / compliance
             if (!window.confirm('Are you sure you want to delete this product?')) return;
             try {
                products = products.filter(p => p.id !== docId);
                saveProducts(products);
                renderProductList(products);
                showModal('Deleted', 'Product deleted successfully.', false);
             } catch (e) {
                console.error("Error deleting product: ", e);
                showModal('Delete Error', `Could not delete product: ${e.message}`, true);
             }
        }

        function loadInitialProducts() {
            products = loadProducts();
            renderProductList(products);
        }

        // --- BARCODE SCANNING FUNCTIONS (ZXING) ---

        function getHints() {
            const hints = new Map();
            // Focus on common formats for retail inventory
            hints.set(DecodeHintType.POSSIBLE_FORMATS, [
                'EAN_13', 'EAN_8', 'UPC_A', 'UPC_E', 'CODE_128', 'CODE_39'
            ]);
            return hints;
        }

        async function startScanner() {
            if (codeReader) {
                stopScanner();
            }

            // Prepare the reader with hints
            codeReader = new BrowserMultiFormatReader(getHints());

            switchToView('scanner');

            try {
                const videoElement = document.getElementById('video-feed');
                document.getElementById('scan-feedback').textContent = 'Starting camera...';

                await codeReader.decodeFromVideoDevice(null, videoElement, (result, error) => {
                    if (result) {
                        handleScanSuccess(result.text);
                    }
                    if (error && !(error instanceof MediaStreamTrack)) {
                        // ZXing often reports this error as it scans multiple frames. We ignore it.
                    }
                });

                document.getElementById('scan-feedback').textContent = 'Scanning in progress...';
            } catch (err) {
                console.error("Camera access failed:", err);
                showModal('Camera Error', 'Could not access the camera. Ensure permissions are granted and no other app is using it.', true);
                switchToView('list');
            }
        }

        function stopScanner() {
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
        }

        function handleScanSuccess(barcode) {
            stopScanner();
            scannedBarcode = barcode;
            document.getElementById('scan-feedback').textContent = `Barcode Found: ${barcode}`;

            if (currentMode === 'manage') {
                // Management Mode: Go to form
                loadFormWithBarcode(barcode);
            } else if (currentMode === 'check') {
                // Price Check Mode: Go to display
                displayPriceCheck(barcode);
            }
        }

        // --- UI & VIEW MANAGEMENT ---

        function switchToView(viewName, skipScanButton = false) {
            stopScanner(); // Stop scanner every time view changes
            const views = {
                'scanner': document.getElementById('scanner-view'),
                'form': document.getElementById('form-view'),
                'list': document.getElementById('list-view'),
                'price-check-view': document.getElementById('price-check-view')
            };

            Object.keys(views).forEach(key => {
                if (views[key]) {
                    views[key].classList.add('hidden');
                }
            });

            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }

            // Special handling for management mode buttons
            document.getElementById('start-scan-add').classList.toggle('hidden', viewName !== 'list' || skipScanButton);
        }

        function loadFormWithBarcode(barcode) {
            currentDocId = null;
            document.getElementById('product-form').reset();
            document.getElementById('form-title').textContent = `Add New Product: ${barcode}`;
            document.getElementById('barcode').value = barcode;
            document.getElementById('save-button').textContent = 'Save Product';

            // Check if this barcode already exists in the current list
            const existingProduct = products.find(p => p.barcode === barcode);

            if (existingProduct) {
                // Pre-fill for editing
                currentDocId = existingProduct.id;
                document.getElementById('docId').value = existingProduct.id;
                document.getElementById('form-title').textContent = `Edit Existing Product: ${barcode}`;
                document.getElementById('size').value = existingProduct.size;
                document.getElementById('price').value = existingProduct.price;
                document.getElementById('save-button').textContent = 'Update Product';
            }

            switchToView('form');
        }

        function renderProductList(productsToRender) {
            const list = document.getElementById('product-list');
            const count = document.getElementById('product-count');
            const emptyMsg = document.getElementById('empty-message');

            list.innerHTML = '';
            count.textContent = productsToRender.length;

            if (productsToRender.length === 0) {
                emptyMsg.classList.remove('hidden');
                list.appendChild(emptyMsg);
                return;
            }
            emptyMsg.classList.add('hidden');

            productsToRender.forEach(p => {
                // p.updatedAt is a timestamp (number)
                const date = p.updatedAt ? new Date(p.updatedAt).toLocaleString() : 'N/A';

                const item = document.createElement('div');
                item.className = 'product-item flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow-sm border border-gray-200 transition hover:shadow-md';
                item.dataset.id = p.id;
                item.dataset.barcode = p.barcode;
                // Ensure size and price are strings for dataset attributes
                item.dataset.size = p.size;
                item.dataset.price = p.price.toString();

                item.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-gray-800 break-all">${p.barcode}</p>
                        <p class="text-xs text-gray-500">Size: ${p.size}</p>
                        <p class="text-xs text-gray-500">Last updated: ${date}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-green-600">$${parseFloat(p.price).toFixed(2)}</p>
                        <div class="flex gap-2 mt-1">
                            <button data-id="${p.id}" data-action="edit" class="text-blue-500 hover:text-blue-700 text-sm font-medium">Edit</button>
                            <button data-id="${p.id}" data-action="delete" class="text-red-500 hover:text-red-700 text-sm font-medium">Delete</button>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function displayPriceCheck(barcode) {
             switchToView('price-check-view', true);
             document.getElementById('check-barcode').textContent = barcode;
             const resultDisplay = document.getElementById('check-result');
             resultDisplay.innerHTML = `<p class="text-gray-500 text-xl font-medium">Searching products...</p>`;

             // Find product directly from in-memory array
             const product = products.find(p => p.barcode === barcode);

             if (product) {
                 const price = product.price;
                 const size = product.size;
                 resultDisplay.innerHTML = `
                    <div class="mt-4 p-4 bg-green-100 rounded-lg">
                        <p class="text-4xl font-extrabold text-green-700">$${parseFloat(price).toFixed(2)}</p>
                        <p class="text-lg text-gray-700 mt-1">Size/Unit: ${size}</p>
                    </div>
                 `;
             } else {
                 resultDisplay.innerHTML = `
                    <div class="mt-4 p-4 bg-red-100 rounded-lg">
                        <p class="text-xl font-extrabold text-red-700">Product Not Found</p>
                        <p class="text-md text-gray-700 mt-1">Barcode <strong>${barcode}</strong> has no saved price.</p>
                    </div>
                 `;
             }
        }


        // --- EVENT HANDLERS ---

        document.getElementById('product-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const productData = {
                docId: form.docId.value || null,
                barcode: form.barcode.value.trim(),
                size: form.size.value.trim(),
                price: parseFloat(form.price.value)
            };

            if (isNaN(productData.price) || productData.price < 0) {
                showModal('Input Error', 'Please enter a valid price.', true);
                return;
            }
            if (!productData.size) {
                 showModal('Input Error', 'Please enter a size/unit.', true);
                 return;
            }

            saveProduct(productData);
        });

        document.getElementById('cancel-button').addEventListener('click', () => {
            switchToView('list');
        });

        document.getElementById('product-list').addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const action = button.dataset.action;
            const id = button.dataset.id;

            if (action === 'edit') {
                const itemElement = button.closest('.product-item');
                const barcode = itemElement.dataset.barcode;
                loadFormWithBarcode(barcode); // Reloads the form pre-filled for editing
            } else if (action === 'delete') {
                deleteProduct(id);
            }
        });

        document.getElementById('start-scan-add').addEventListener('click', () => {
            startScanner();
        });

        document.getElementById('rescan-button').addEventListener('click', () => {
            startScanner();
        });

        // Mode switching logic (still uses localStorage)
        function setMode(mode) {
            currentMode = mode;
            // Save the user's preferred mode to localStorage
            localStorage.setItem('inventoryMode', mode);

            const manageBtn = document.getElementById('mode-manage');
            const checkBtn = document.getElementById('mode-check');

            // Update button styles
            manageBtn.classList.remove('active-mode', 'bg-blue-600', 'bg-gray-500');
            checkBtn.classList.remove('active-mode', 'bg-blue-600', 'bg-gray-500');

            if (mode === 'manage') {
                manageBtn.classList.add('bg-blue-600', 'active-mode');
                checkBtn.classList.add('bg-gray-500');
                // Switch to the list view immediately
                switchToView('list');
            } else { // 'check' mode
                checkBtn.classList.add('bg-blue-600', 'active-mode');
                manageBtn.classList.add('bg-gray-500');
                // Start scanning immediately in price check mode
                startScanner();
            }
        }

        document.getElementById('mode-manage').addEventListener('click', () => setMode('manage'));
        document.getElementById('mode-check').addEventListener('click', () => setMode('check'));

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
             // 1. Load mode from localStorage if available
             const savedMode = localStorage.getItem('inventoryMode');
             if (savedMode) {
                 currentMode = savedMode;
             }

             // 2. Set initial button styles based on the determined currentMode
             const manageBtn = document.getElementById('mode-manage');
             const checkBtn = document.getElementById('mode-check');

             if (currentMode === 'manage') {
                 manageBtn.classList.remove('bg-gray-500');
                 manageBtn.classList.add('bg-blue-600');
                 checkBtn.classList.remove('bg-blue-600');
                 checkBtn.classList.add('bg-gray-500');
             } else {
                 manageBtn.classList.remove('bg-blue-600');
                 manageBtn.classList.add('bg-gray-500');
                 checkBtn.classList.remove('bg-gray-500');
                 checkBtn.classList.add('bg-blue-600');
             }

             // 3. Load products and set initial view
             loadInitialProducts();

             if (currentMode === 'check') {
                 startScanner();
             } else {
                 switchToView('list');
             }
        });
    </script>
</body>
</html>
